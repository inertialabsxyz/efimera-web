---
interface Article {
    _id: string;
    title: string;
    slug: { current: string };
    category: string;
    excerpt?: string;
    imageUrl?: string;
}

interface Props {
    articles: Article[];
}

const { articles } = Astro.props;
---

<div id="search-modal" class="search-modal" aria-hidden="true">
    <div class="search-modal-backdrop"></div>
    <div class="search-modal-content">
        <div class="search-modal-header">
            <div class="search-input-wrapper">
                <svg
                    class="search-icon"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input
                    type="text"
                    id="search-input"
                    placeholder="Buscar artículos..."
                    autocomplete="off"
                />
                <kbd class="search-shortcut">ESC</kbd>
            </div>
        </div>
        <div class="search-modal-body" id="search-results">
            <div class="search-empty-state">
                <p>Escribe para buscar artículos</p>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ articles }}>
    const modal = document.getElementById("search-modal");
    const searchInput = document.getElementById("search-input");
    const resultsContainer = document.getElementById("search-results");
    const backdrop = document.querySelector(".search-modal-backdrop");

    window.searchArticles = articles;

    function openModal() {
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
        setTimeout(() => searchInput.focus(), 50);
    }

    function closeModal() {
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        searchInput.value = "";
        renderResults([]);
    }

    function truncateText(text, maxLength) {
        if (!text) return "";
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength).trim() + "...";
    }

    function renderResults(results) {
        if (searchInput.value.trim() === "") {
            resultsContainer.innerHTML = `
                <div class="search-empty-state">
                    <p>Escribe para buscar artículos</p>
                </div>
            `;
            return;
        }

        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="search-empty-state">
                    <p>No se encontraron artículos</p>
                </div>
            `;
            return;
        }

        resultsContainer.innerHTML = `
            <div class="search-results-header">
                <span class="search-results-count">${results.length} ${results.length === 1 ? "resultado" : "resultados"}</span>
            </div>
            <div class="search-results-list">
                ${results
                    .map(
                        (article, index) => `
                    <a href="/article/${article.slug.current}" class="search-result-card" data-index="${index}">
                        <div class="search-result-image">
                            ${
                                article.imageUrl
                                    ? `<img src="${article.imageUrl}" alt="" loading="lazy" />`
                                    : `<div class="search-result-image-placeholder"></div>`
                            }
                        </div>
                        <div class="search-result-content">
                            <h3 class="search-result-title">${article.title}</h3>
                            ${article.excerpt ? `<p class="search-result-excerpt">${truncateText(article.excerpt, 120)}</p>` : ""}
                            <span class="search-result-category">${article.category}</span>
                        </div>
                    </a>
                `,
                    )
                    .join("")}
            </div>
        `;
    }

    function searchArticlesFunc(query) {
        const normalizedQuery = query.toLowerCase().trim();
        if (!normalizedQuery) return [];

        return window.searchArticles.filter((article) => {
            const title = article.title?.toLowerCase() || "";
            const category = article.category?.toLowerCase() || "";
            const excerpt = article.excerpt?.toLowerCase() || "";

            return (
                title.includes(normalizedQuery) ||
                category.includes(normalizedQuery) ||
                excerpt.includes(normalizedQuery)
            );
        });
    }

    searchInput?.addEventListener("input", (e) => {
        const results = searchArticlesFunc(e.target.value);
        renderResults(results);
    });

    backdrop?.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
            e.preventDefault();
            openModal();
        }
        if (
            e.key === "/" &&
            !["INPUT", "TEXTAREA"].includes(document.activeElement?.tagName)
        ) {
            e.preventDefault();
            openModal();
        }

        if (
            e.key === "Escape" &&
            modal.getAttribute("aria-hidden") === "false"
        ) {
            closeModal();
        }

        if (modal.getAttribute("aria-hidden") === "false") {
            const items = resultsContainer.querySelectorAll(
                ".search-result-card",
            );
            const currentIndex = Array.from(items).findIndex(
                (item) => item === document.activeElement,
            );

            if (e.key === "ArrowDown") {
                e.preventDefault();
                if (currentIndex < items.length - 1) {
                    items[currentIndex + 1].focus();
                } else if (
                    document.activeElement === searchInput &&
                    items.length > 0
                ) {
                    items[0].focus();
                }
            }

            if (e.key === "ArrowUp") {
                e.preventDefault();
                if (currentIndex > 0) {
                    items[currentIndex - 1].focus();
                } else if (currentIndex === 0) {
                    searchInput.focus();
                }
            }
        }
    });

    window.openSearchModal = openModal;
</script>

<style is:global>
    .search-modal {
        position: fixed;
        inset: 0;
        z-index: 2000;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 6vh;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.2s ease,
            visibility 0.2s ease;
    }

    .search-modal[aria-hidden="false"] {
        opacity: 1;
        visibility: visible;
    }

    .search-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
    }

    .search-modal-content {
        position: relative;
        width: 100%;
        max-width: 600px;
        max-height: 80vh;
        margin: 0 var(--space-md);
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        transform: translateY(-10px);
        transition: transform 0.2s ease;
        overflow: hidden;
    }

    .search-modal[aria-hidden="false"] .search-modal-content {
        transform: translateY(0);
    }

    .search-modal-header {
        padding: var(--space-sm) var(--space-md);
        border-bottom: 1px solid var(--color-border);
        flex-shrink: 0;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 0;
        color: var(--color-text-muted);
        pointer-events: none;
    }

    #search-input {
        width: 100%;
        padding: 0.5rem 0 0.5rem 2.25rem;
        font-family: var(--font-body);
        font-size: 1.1rem;
        border: none;
        background: transparent;
        color: var(--color-text);
    }

    #search-input:focus {
        outline: none;
    }

    #search-input::placeholder {
        color: var(--color-text-muted);
    }

    .search-shortcut {
        font-family: var(--font-body);
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
        background: #f5f5f5;
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
        flex-shrink: 0;
    }

    .search-modal-body {
        flex: 1;
        overflow-y: auto;
    }

    .search-empty-state {
        padding: var(--space-lg) var(--space-md);
        text-align: center;
        color: var(--color-text-muted);
        font-size: 0.9rem;
    }

    .search-results-header {
        padding: var(--space-xs) var(--space-md);
        border-bottom: 1px solid var(--color-border);
        background: #fafafa;
    }

    .search-results-count {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-text-muted);
    }

    .search-results-list {
        padding: 0;
    }

    /* Search Result Card */
    .search-result-card {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-sm) var(--space-md);
        text-decoration: none;
        color: var(--color-text);
        border-bottom: 1px solid var(--color-border);
        transition: background-color 0.15s ease;
    }

    .search-result-card:last-child {
        border-bottom: none;
    }

    .search-result-card:hover,
    .search-result-card:focus {
        background: #f8f8f8;
        outline: none;
    }

    .search-result-image {
        flex-shrink: 0;
        width: 88px;
        height: 66px;
        background: #f0f0f0;
        overflow: hidden;
    }

    .search-result-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .search-result-image-placeholder {
        width: 100%;
        height: 100%;
        background: #e8e8e8;
    }

    .search-result-content {
        flex: 1;
        min-width: 0;
    }

    .search-result-title {
        font-family: var(--font-display);
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.35;
        margin: 0 0 0.3rem 0;
        color: var(--color-text);
    }

    .search-result-excerpt {
        font-size: 0.8rem;
        color: var(--color-text-muted);
        line-height: 1.45;
        margin: 0 0 0.5rem 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .search-result-category {
        display: inline-block;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #999;
        background: #f0f0f0;
        padding: 0.2rem 0.5rem;
        border-radius: 2px;
    }

    @media (max-width: 480px) {
        .search-modal {
            padding-top: 0;
        }

        .search-modal-content {
            max-height: 100vh;
            max-height: 100dvh;
            margin: 0;
            border: none;
        }

        .search-result-image {
            width: 72px;
            height: 54px;
        }

        .search-result-title {
            font-size: 0.9rem;
        }

        .search-result-excerpt {
            font-size: 0.75rem;
            -webkit-line-clamp: 1;
        }
    }
</style>
