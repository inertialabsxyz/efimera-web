---
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import ImageCarousel from "../../../components/ImageCarousel.astro";
import { getArticle, urlFor, languages, defaultLanguage } from "../../../lib/sanity";
import type { Language } from "../../../lib/sanity";
import { toHTML } from "@portabletext/to-html";
import { translations } from "../../../i18n/translations";

const { slug, lang } = Astro.params as { slug: string; lang: Language };

// Validate language
if (!languages.some((l) => l.id === lang)) {
  return Astro.redirect(`/${defaultLanguage}/article/${slug}`);
}

const article = await getArticle(slug, lang);
const t = translations[lang];

if (!article) {
  return Astro.redirect(`/${lang}`);
}

const formattedDate = new Date(article.publishedAt).toLocaleDateString(
  lang === "es" ? "es-ES" : "en-US",
  {
    month: "long",
    day: "numeric",
    year: "numeric",
  }
);

// Prepare gallery images if available, otherwise use mainImage
const hasGallery = article.gallery && article.gallery.length > 0;
const galleryImages = hasGallery
  ? article.gallery.map((img: any) => ({
      url: urlFor(img).url(),
      alt: img.alt || article.title,
    }))
  : article.mainImage
    ? [
        {
          url: urlFor(article.mainImage).url(),
          alt: article.mainImage.alt || article.title,
        },
      ]
    : [
        {
          url: `https://picsum.photos/seed/${slug}/800/600`,
          alt: article.title,
        },
      ];

// Convert Portable Text to HTML
function renderImage({ value }: { value: any }) {
  if (!value?.asset?._ref) {
    return "";
  }
  const imgUrl = urlFor(value).width(1200).url();
  const alt = value.alt || "";
  const caption = value.caption ? `<figcaption>${value.caption}</figcaption>` : "";

  let style = "";
  if (value.displayWidth || value.displayHeight) {
    if (value.displayWidth) style += `width: ${value.displayWidth}px; height: auto;`;
    else if (value.displayHeight) style += `height: ${value.displayHeight}px; width: auto;`;
  }
  const styleAttr = style ? ` style="${style}"` : "";

  const img = `<img src="${imgUrl}" alt="${alt}"${styleAttr} />`;
  const content = value.link
    ? `<a href="${value.link}" target="_blank" rel="noopener noreferrer">${img}</a>`
    : img;

  return `<figure>${content}${caption}</figure>`;
}

const bodyHtml = article.body
  ? toHTML(article.body, {
      components: {
        types: {
          image: renderImage,
        },
      },
    })
  : "";
---

<Layout title={`${article.title} — Efímera`} lang={lang}>
  <article>
    <header class="article-header">
      <span class="article-category">{article.category}</span>
      <h1 class="article-title">{article.title}</h1>
      {article.excerpt && <p class="article-excerpt">{article.excerpt}</p>}
    </header>

    <div class="article-hero">
      <ImageCarousel images={galleryImages} articleTitle={article.title} />
    </div>

    <div class="article-content" set:html={bodyHtml} />

    {
      article.relatedArticles && article.relatedArticles.length > 0 && (
        <section class="related-articles">
          <h2>{t.article.relatedArticles}</h2>
          <div class="related-articles-grid">
            {article.relatedArticles.map((related: any) => (
              <a href={`/${lang}/article/${related.slug.current}`} class="related-article-card">
                {related.mainImage && (
                  <div class="related-article-image">
                    <img
                      src={urlFor(related.mainImage).width(400).height(300).url()}
                      alt={related.title}
                    />
                  </div>
                )}
                <div class="related-article-content">
                  <span class="related-article-category">{related.category}</span>
                  <h3>{related.title}</h3>
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }
  </article>
</Layout>

<style>
  article {
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .related-articles {
    max-width: 680px;
    margin: var(--space-lg) auto;
    padding: 0 var(--space-md);
    border-top: 1px solid var(--color-border);
    padding-top: var(--space-lg);
  }

  .related-articles h2 {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: var(--space-md);
    color: var(--color-text-muted);
  }

  .related-articles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
  }

  .related-article-card {
    text-decoration: none;
    color: inherit;
  }

  .related-article-image {
    aspect-ratio: 4/3;
    overflow: hidden;
    background: #f5f5f5;
    margin-bottom: var(--space-xs);
  }

  .related-article-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .related-article-card:hover .related-article-image img {
    transform: scale(1.03);
  }

  .related-article-category {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
  }

  .related-article-content h3 {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 400;
    margin-top: 0.25rem;
    text-transform: uppercase;
  }

  @media (max-width: 480px) {
    .related-articles-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
